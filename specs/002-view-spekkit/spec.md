# Feature Specification: 遊戲伺服器推廣平台 - 完整系統規範

**Feature Branch**: `002-view-spekkit`
**Created**: 2025-10-08
**Status**: Baseline Documentation
**Input**: User description: "幫我view過整份專案，整理出目前這個專案所有的功能與規範用於建立spekkit以利後續的執行"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 使用者註冊與身份管理 (Priority: P1)

平台需要讓新使用者能夠自主註冊帳號，並管理自己的個人資訊。使用者應能使用帳號或電子郵件登入系統，系統會根據使用者的角色提供相應的功能權限。

**Why this priority**: 這是整個平台的基礎功能，沒有使用者認證系統，其他所有功能都無法運作。

**Independent Test**: 可以透過註冊新帳號、登入、查看個人資料、登出等完整流程來獨立測試，驗證使用者能成功建立和管理帳號。

**Acceptance Scenarios**:

1. **Given** 訪客造訪平台首頁, **When** 點擊註冊並填寫使用者名稱、電子郵件、密碼, **Then** 系統創建新帳號並自動登入
2. **Given** 已註冊使用者輸入正確的帳號/郵箱和密碼, **When** 點擊登入, **Then** 系統驗證身份並導向儀表板
3. **Given** 使用者已登入, **When** 查看個人資料頁面, **Then** 顯示完整的個人資訊（姓名、電子郵件、聯絡方式等）
4. **Given** 使用者登入狀態, **When** 點擊登出按鈕, **Then** 系統清除登入狀態並導向首頁
5. **Given** 使用者輸入錯誤密碼超過5次, **When** 嘗試第6次登入, **Then** 系統鎖定帳號並顯示解鎖時間

---

### User Story 2 - 五級角色權限體系 (Priority: P1)

平台需要支援五種不同等級的使用者角色：超級管理員、管理員、服主、審核員、一般使用者。每個角色應擁有明確定義的權限範圍，確保使用者只能執行其權限範圍內的操作。

**Why this priority**: 權限系統是多租戶平台的核心安全機制，確保資料隔離和操作授權。

**Independent Test**: 可以創建不同角色的測試帳號，嘗試執行各種操作，驗證權限控制正確運作（如一般使用者無法審核伺服器申請）。

**Acceptance Scenarios**:

1. **Given** 超級管理員登入, **When** 查看系統功能選單, **Then** 顯示所有管理功能（使用者管理、角色管理、權限管理、系統設定）
2. **Given** 服主登入, **When** 查看功能選單, **Then** 只顯示自己伺服器的管理功能，無法看到其他服主的伺服器
3. **Given** 審核員登入, **When** 查看待審核列表, **Then** 顯示待審核的伺服器申請和推廣獎勵，但無法編輯伺服器設定
4. **Given** 一般使用者登入, **When** 嘗試訪問管理後台, **Then** 系統拒絕訪問並顯示權限不足訊息
5. **Given** 管理員為使用者分配「服主」角色, **When** 使用者重新登入, **Then** 使用者獲得伺服器管理權限

---

### User Story 3 - 伺服器註冊與審核流程 (Priority: P1)

服主需要能夠註冊自己的遊戲伺服器到平台，提供伺服器基本資訊、遊戲設定、連線資訊等。審核員或管理員應能查看待審核的伺服器申請，並決定核准或拒絕申請。

**Why this priority**: 這是平台的核心業務流程，沒有伺服器就沒有推廣標的。

**Independent Test**: 服主提交新伺服器申請，審核員審核並核准/拒絕，驗證整個申請流程運作正常。

**Acceptance Scenarios**:

1. **Given** 服主登入系統, **When** 填寫伺服器名稱、遊戲類型、IP、描述等資訊並提交, **Then** 系統創建伺服器記錄，狀態設為「待審核」
2. **Given** 審核員查看待審核列表, **When** 點擊某個伺服器申請查看詳情, **Then** 顯示完整的伺服器資訊供審核
3. **Given** 審核員審核伺服器申請, **When** 點擊「核准」, **Then** 伺服器狀態改為「已核准」，服主收到通知
4. **Given** 審核員審核伺服器申請發現問題, **When** 點擊「拒絕」並填寫拒絕原因, **Then** 伺服器狀態改為「已拒絕」，服主收到通知及原因
5. **Given** 伺服器被拒絕, **When** 服主修改資訊後重新提交, **Then** 伺服器狀態重新變為「待審核」

---

### User Story 4 - 伺服器資料與設定管理 (Priority: P2)

服主需要能夠管理伺服器的完整資訊，包括基本設定、視覺素材（Logo、背景圖、Banner）、社群連結、遊戲特色標籤等。服主還需要設定資料庫連線資訊以便系統自動發放獎勵。

**Why this priority**: 完整的伺服器資訊有助於吸引玩家，資料庫設定則是自動化獎勵發放的基礎。

**Independent Test**: 服主登入後編輯伺服器資訊、上傳圖片、設定資料庫連線，並測試連線成功。

**Acceptance Scenarios**:

1. **Given** 服主進入伺服器管理頁面, **When** 上傳伺服器 Logo、背景圖、Banner 圖片, **Then** 系統儲存圖片並在伺服器頁面顯示
2. **Given** 服主編輯伺服器資訊, **When** 修改遊戲版本、最大玩家數、Discord 連結、特色標籤, **Then** 系統儲存更新並即時生效
3. **Given** 服主設定資料庫連線, **When** 填寫主機、資料庫名稱、帳號、密碼, **Then** 系統測試連線並回報成功或失敗
4. **Given** 服主設定獎勵表映射, **When** 指定獎勵資料表名稱和欄位映射關係, **Then** 系統測試映射並驗證欄位存在
5. **Given** 服主設定通知方式, **When** 選擇 Email 或 LINE 通知並填寫相關資訊, **Then** 系統儲存通知設定供後續使用

---

### User Story 5 - 推廣連結生成與分享 (Priority: P1)

使用者需要能夠為喜歡的伺服器生成專屬推廣連結，用於分享給朋友。系統應自動生成唯一的推廣代碼、完整推廣連結、短連結、QR Code，並提供適合各種社群平台的分享內容。

**Why this priority**: 這是平台的核心價值主張，推廣連結是整個推廣系統的起點。

**Independent Test**: 使用者選擇伺服器，生成推廣連結，複製連結並透過社群平台分享，驗證連結可正常訪問。

**Acceptance Scenarios**:

1. **Given** 使用者瀏覽伺服器列表, **When** 選擇某個伺服器點擊「推廣此伺服器」, **Then** 系統生成唯一推廣連結、QR Code 並顯示
2. **Given** 使用者已生成推廣連結, **When** 點擊「複製連結」按鈕, **Then** 推廣連結複製到剪貼簿
3. **Given** 使用者查看推廣素材, **When** 選擇社群平台（Facebook/Twitter/Discord/LINE）, **Then** 系統顯示該平台適用的分享文案和連結
4. **Given** 使用者下載 QR Code, **When** 點擊下載按鈕, **Then** 系統提供 PNG 格式的 QR Code 圖片
5. **Given** 使用者已有該伺服器的活躍推廣, **When** 再次嘗試創建推廣, **Then** 系統提示「已存在活躍推廣」並顯示現有連結

---

### User Story 6 - 推廣效果追蹤與分析 (Priority: P2)

使用者需要能夠查看自己推廣連結的效果，包括總點擊數、唯一訪客數、轉換數、轉換率等。系統應提供詳細的點擊來源分析、時間分佈圖表等，幫助使用者優化推廣策略。

**Why this priority**: 效果追蹤是激勵使用者持續推廣的關鍵，數據驅動的決策能提升推廣效率。

**Independent Test**: 使用者分享推廣連結後，查看推廣分析頁面，驗證點擊數據被正確記錄和展示。

**Acceptance Scenarios**:

1. **Given** 訪客點擊推廣連結, **When** 訪問伺服器頁面, **Then** 系統記錄點擊資訊（IP、時間、來源、裝置）
2. **Given** 使用者查看推廣分析頁面, **When** 選擇某個推廣連結, **Then** 顯示總點擊數、唯一訪客數、轉換數、轉換率
3. **Given** 使用者查看點擊趨勢, **When** 選擇時間範圍（7天/30天/全部）, **Then** 顯示點擊量時間分佈圖表
4. **Given** 使用者查看來源分析, **When** 查看 Referrer 分析, **Then** 顯示點擊來自哪些網站/平台
5. **Given** 使用者匯出資料, **When** 選擇日期範圍並點擊「匯出 CSV」, **Then** 下載包含所有點擊記錄的 CSV 檔案

---

### User Story 7 - 推廣獎勵自動化處理 (Priority: P1)

當有新玩家透過推廣連結註冊並達成轉換條件時，系統應自動創建獎勵記錄。根據伺服器設定，系統可以自動審核並發放獎勵，或進入人工審核流程。獎勵狀態應清楚追蹤（待審核、已審核、已發放、已取消、發放失敗）。

**Why this priority**: 自動化獎勵處理是降低管理成本、提升使用者體驗的關鍵。

**Independent Test**: 模擬推廣轉換，驗證系統自動創建獎勵，並根據設定完成審核和發放流程。

**Acceptance Scenarios**:

1. **Given** 新玩家透過推廣連結註冊, **When** 完成首次登入遊戲, **Then** 系統自動創建推廣獎勵記錄，狀態為「待審核」
2. **Given** 伺服器開啟自動審核, **When** 獎勵創建, **Then** 系統自動將狀態改為「已審核」
3. **Given** 獎勵狀態為「已審核」且發放方式為「自動」, **When** 系統執行發放任務, **Then** 將獎勵寫入遊戲資料庫，狀態改為「已發放」
4. **Given** 審核員查看待審核獎勵, **When** 點擊「批量審核」並選擇多筆獎勵, **Then** 所有選中的獎勵狀態改為「已審核」
5. **Given** 獎勵發放失敗, **When** 系統記錄錯誤訊息, **Then** 獎勵狀態改為「發放失敗」，管理員收到通知

---

### User Story 8 - 獎勵設定與規則管理 (Priority: P2)

服主需要能夠設定不同類型的獎勵規則，包括推廣獎勵、活動獎勵、簽到獎勵等。每種獎勵應能設定觸發條件、獎勵內容、數量限制（每日/每週/每月上限）、有效期限等。

**Why this priority**: 靈活的獎勵規則讓服主能根據營運策略調整激勵機制。

**Independent Test**: 服主創建新的獎勵規則，設定觸發條件和限制，驗證規則生效並正確計算獎勵。

**Acceptance Scenarios**:

1. **Given** 服主進入獎勵設定頁面, **When** 創建推廣獎勵規則並設定「首次推廣成功給予 100 金幣」, **Then** 系統儲存規則並在推廣轉換時套用
2. **Given** 服主設定每日獎勵上限, **When** 設定「每人每日最多獲得 3 次推廣獎勵」, **Then** 系統在第 4 次推廣時拒絕發放獎勵
3. **Given** 服主設定獎勵有效期, **When** 設定「此獎勵規則在 2025-12-31 前有效」, **Then** 過期後系統不再使用此規則
4. **Given** 服主設定自動審核, **When** 勾選「自動審核」和「自動發放」, **Then** 獎勵無需人工介入即可完成發放
5. **Given** 服主查看獎勵規則統計, **When** 查看某個規則的使用情況, **Then** 顯示使用次數、成功次數、失敗次數

---

### User Story 9 - 統計分析與儀表板 (Priority: P2)

不同角色的使用者需要看到與其權限對應的統計資料。管理員看到全平台統計，服主看到自己伺服器的推廣效果，一般使用者看到自己的推廣成績和獎勵記錄。

**Why this priority**: 數據可視化幫助各角色理解平台運營狀況，做出更好的決策。

**Independent Test**: 不同角色登入後查看儀表板，驗證顯示的資料範圍和權限一致。

**Acceptance Scenarios**:

1. **Given** 管理員登入儀表板, **When** 查看首頁, **Then** 顯示全平台統計（總使用者數、伺服器數、推廣數、獎勵發放數）
2. **Given** 服主登入儀表板, **When** 查看伺服器統計, **Then** 顯示自己伺服器的推廣效能、Top 推廣者、獎勵發放情況
3. **Given** 一般使用者登入儀表板, **When** 查看個人統計, **Then** 顯示自己的推廣列表、總點擊數、轉換數、獲得獎勵
4. **Given** 使用者查看推廣趨勢, **When** 選擇時間範圍（7/30/90天）, **Then** 顯示該期間的推廣趨勢圖表
5. **Given** 管理員比較伺服器效能, **When** 選擇多個伺服器進行比較, **Then** 顯示各伺服器的轉換率、獎勵發放效率等指標

---

### User Story 10 - 前端管理介面 (Priority: P2)

平台需提供現代化的管理後台介面，支援側邊欄導航、深色模式、響應式設計。管理員和服主應能透過直觀的介面完成所有管理任務，無需使用命令列或直接操作資料庫。

**Why this priority**: 友善的使用者介面降低學習成本，提升管理效率。

**Independent Test**: 管理員登入後台，透過介面完成使用者管理、伺服器審核、權限分配等任務。

**Acceptance Scenarios**:

1. **Given** 管理員登入後台, **When** 查看側邊欄選單, **Then** 顯示分類清楚的功能選單（儀表板、使用者管理、伺服器管理、推廣管理、獎勵管理、設定）
2. **Given** 使用者點擊深色模式切換, **When** 切換主題, **Then** 整個介面切換為深色配色且儲存偏好設定
3. **Given** 管理員使用手機訪問後台, **When** 查看介面, **Then** 自動調整為響應式佈局，功能完整可用
4. **Given** 管理員查看使用者列表, **When** 使用搜尋、篩選、分頁功能, **Then** 快速找到目標使用者並執行操作
5. **Given** 服主上傳伺服器圖片, **When** 拖曳檔案到上傳區域, **Then** 系統顯示上傳進度並完成上傳

---

### Edge Cases

- 當推廣連結過期後被點擊，系統如何處理？（顯示友善的過期訊息，並引導訪客到伺服器主頁）
- 當同一 IP 短時間內多次點擊推廣連結，如何防止刷點擊？（使用 IP + User Agent + Fingerprint 識別唯一訪客，24小時內重複點擊不計入）
- 當伺服器資料庫連線失敗時，獎勵如何處理？（獎勵狀態標記為「發放失敗」，記錄錯誤訊息，管理員可查看並手動重試）
- 當使用者同時擁有多個角色時，權限如何計算？（取所有角色權限的聯集，擁有最高權限）
- 當伺服器被停權後，現有的推廣連結是否仍有效？（推廣連結暫停，點擊時顯示「伺服器暫時無法推廣」）
- 當使用者刪除帳號時，其推廣記錄和獎勵如何處理？（使用軟刪除，保留歷史記錄供統計，但標記為已刪除使用者）
- 當多個服主管理同一伺服器時，權限如何分配？（支援多服主共同管理，透過角色分配實現權限控制）
- 當推廣獎勵的遊戲角色不存在時，如何處理？（發放失敗，通知使用者檢查角色名稱，提供重新提交機會）

## Requirements *(mandatory)*

### Functional Requirements

#### 使用者認證與管理

- **FR-001**: 系統必須允許訪客使用 username、email、password 註冊新帳號
- **FR-002**: 系統必須驗證 email 格式、username 唯一性、密碼強度
- **FR-003**: 使用者必須能使用 username 或 email 登入系統
- **FR-004**: 系統必須使用安全的密碼雜湊演算法儲存密碼
- **FR-005**: 系統必須在登入失敗 5 次後鎖定帳號 30 分鐘
- **FR-006**: 系統必須記錄每次登入的 IP 地址、User Agent、登入時間
- **FR-007**: 使用者必須能查看和更新個人資料（姓名、電話、LINE ID、Discord ID、頭像）
- **FR-008**: 系統必須支援 Session Token 認證機制，Token 有效期為 1 小時
- **FR-009**: 系統必須提供 Token 刷新機制，Refresh Token 有效期為 7 天
- **FR-010**: 使用者必須能安全登出，系統清除所有 Session 資料

#### 角色權限系統

- **FR-011**: 系統必須支援五級角色：Super Admin (Level 1)、Admin (Level 2)、Server Owner (Level 3)、Reviewer (Level 4)、User (Level 5)
- **FR-012**: 系統必須支援基於資源-動作的權限模型（如 `users.create`、`servers.approve`）
- **FR-013**: 系統必須支援角色-權限多對多關聯
- **FR-014**: 系統必須支援使用者-角色多對多關聯
- **FR-015**: 系統必須在每次 API 請求時驗證使用者權限
- **FR-016**: 管理員必須能為使用者分配和移除角色
- **FR-017**: 系統必須支援角色有效期限設定
- **FR-018**: 當使用者擁有多個角色時，系統必須授予所有角色權限的聯集
- **FR-019**: 系統必須記錄角色分配者和分配時間供審計

#### 伺服器管理

- **FR-020**: 服主必須能註冊新伺服器，提供名稱、遊戲類型、IP、描述等資訊
- **FR-021**: 系統必須為每個伺服器生成唯一的 server_code
- **FR-022**: 新註冊的伺服器狀態必須設為「pending（待審核）」
- **FR-023**: 審核員必須能查看待審核伺服器列表
- **FR-024**: 審核員必須能核准伺服器，記錄審核者和審核時間
- **FR-025**: 審核員必須能拒絕伺服器，並提供拒絕原因
- **FR-026**: 服主必須能上傳伺服器 Logo、背景圖、Banner 圖片
- **FR-027**: 系統必須驗證上傳圖片的格式（jpg, png, gif）和大小限制
- **FR-028**: 服主必須能設定伺服器資料庫連線資訊
- **FR-029**: 系統必須提供資料庫連線測試功能
- **FR-030**: 服主必須能設定獎勵表映射（資料表名稱、欄位映射）
- **FR-031**: 系統必須提供獎勵表映射測試功能
- **FR-032**: 服主必須能設定通知方式（Email、LINE）
- **FR-033**: 服主必須能編輯伺服器基本資訊、社群連結、特色標籤
- **FR-034**: 系統必須支援伺服器狀態管理（pending, approved, rejected, suspended, inactive）
- **FR-035**: 系統必須支援伺服器精選功能，設定精選期限

#### 推廣系統

- **FR-036**: 使用者必須能為已核准的伺服器創建推廣連結
- **FR-037**: 系統必須生成唯一的 32 字元推廣代碼
- **FR-038**: 系統必須生成完整推廣連結（含 UTM 參數）
- **FR-039**: 系統必須生成短連結
- **FR-040**: 系統必須生成 QR Code
- **FR-041**: 每個使用者對每個伺服器只能有一個活躍推廣
- **FR-042**: 系統必須提供適合不同社群平台的分享內容（Facebook、Twitter、Discord、LINE）
- **FR-043**: 當訪客點擊推廣連結時，系統必須記錄點擊資訊（IP、時間、Referrer、User Agent）
- **FR-044**: 系統必須使用 IP + User Agent + Fingerprint 識別唯一訪客
- **FR-045**: 系統必須區分總點擊數和唯一點擊數
- **FR-046**: 當推廣轉換成功時，系統必須更新轉換計數
- **FR-047**: 使用者必須能查看推廣連結的詳細分析（點擊數、轉換數、轉換率）
- **FR-048**: 系統必須提供推廣趨勢圖表（按日/週/月）
- **FR-049**: 系統必須提供 Referrer 來源分析
- **FR-050**: 使用者必須能匯出推廣資料為 CSV 或 JSON 格式
- **FR-051**: 使用者必須能暫停和恢復推廣連結
- **FR-052**: 系統必須提供推廣連結驗證 API

#### 獎勵系統

- **FR-053**: 系統必須支援多種獎勵類型（promotion, activity, checkin, referral, bonus）
- **FR-054**: 當推廣轉換成功時，系統必須自動創建獎勵記錄
- **FR-055**: 獎勵記錄必須包含使用者、伺服器、推廣連結、獎勵類型、獎勵內容、數量等資訊
- **FR-056**: 系統必須支援獎勵狀態流程（pending → approved → distributed / cancelled / failed）
- **FR-057**: 系統必須根據伺服器設定決定是否自動審核獎勵
- **FR-058**: 審核員必須能查看待審核獎勵列表
- **FR-059**: 審核員必須能批量審核獎勵
- **FR-060**: 系統必須支援多種獎勵發放方式（auto, manual, api, database）
- **FR-061**: 當使用 database 發放方式時，系統必須直接寫入遊戲資料庫
- **FR-062**: 發放失敗時，系統必須記錄錯誤訊息和重試次數
- **FR-063**: 系統必須記錄審核者、審核時間、發放時間
- **FR-064**: 使用者必須能查看自己的獎勵歷史
- **FR-065**: 系統必須提供獎勵統計（總計、分類統計、狀態分佈）
- **FR-066**: 系統必須提供獎勵排行榜
- **FR-067**: 服主必須能設定獎勵規則（觸發條件、獎勵內容、限制）
- **FR-068**: 系統必須支援獎勵數量限制（每日/每週/每月上限）
- **FR-069**: 系統必須支援獎勵有效期限
- **FR-070**: 系統必須追蹤獎勵規則的使用統計

#### 統計分析

- **FR-071**: 系統必須提供管理員儀表板（全平台統計）
- **FR-072**: 系統必須提供服主儀表板（伺服器推廣效能）
- **FR-073**: 系統必須提供使用者儀表板（個人推廣成績）
- **FR-074**: 系統必須計算推廣效能指標（點擊率、轉換率、活躍推廣者數）
- **FR-075**: 系統必須提供推廣趨勢分析（daily/weekly/monthly）
- **FR-076**: 系統必須提供 Top 推廣者排行榜
- **FR-077**: 系統必須提供伺服器比較功能（多伺服器效能對比）
- **FR-078**: 系統必須提供即時統計（活躍推廣數、待處理獎勵數）
- **FR-079**: 系統必須支援資料匯出（CSV, JSON, XLSX）
- **FR-080**: 系統必須支援日期範圍篩選

#### 前端介面

- **FR-081**: 系統必須提供公開頁面（首頁、伺服器列表、伺服器詳情、登入、註冊）
- **FR-082**: 系統必須提供管理後台頁面（儀表板、使用者管理、伺服器管理、推廣管理、獎勵管理、設定）
- **FR-083**: 系統必須提供側邊欄導航，支援收合功能
- **FR-084**: 系統必須支援深色模式切換，並儲存使用者偏好
- **FR-085**: 系統必須支援響應式設計（桌面、平板、手機）
- **FR-086**: 系統必須在所有列表頁面提供搜尋、篩選、分頁功能
- **FR-087**: 系統必須提供檔案拖曳上傳功能
- **FR-088**: 系統必須顯示操作進度（上傳進度、處理進度）
- **FR-089**: 系統必須提供友善的錯誤訊息和成功提示

#### 安全與效能

- **FR-090**: 系統必須實施 CORS 控制，只允許授權的來源訪問 API
- **FR-091**: 系統必須實施 API 速率限制（每 IP 每分鐘最多 60 次請求）
- **FR-092**: 系統必須驗證所有 API 輸入資料，防止 SQL Injection 和 XSS 攻擊
- **FR-093**: 系統必須使用 Prepared Statements 執行資料庫查詢
- **FR-094**: 系統必須對所有輸出進行轉義處理
- **FR-095**: 系統必須使用軟刪除保護重要資料
- **FR-096**: 所有列表查詢必須支援分頁，避免一次載入過多資料
- **FR-097**: 系統必須在關鍵資料表欄位建立索引提升查詢效能
- **FR-098**: 系統必須記錄所有關鍵操作的審計日誌

### Key Entities

- **User（使用者）**: 平台使用者，包含認證資訊、個人資料、聯絡方式、安全設定
- **Role（角色）**: 使用者角色定義，包含角色名稱、代碼、等級、狀態
- **Permission（權限）**: 系統權限定義，基於資源-動作模型
- **Server（伺服器）**: 遊戲伺服器資訊，包含基本資訊、連線資訊、視覺素材、社群連結
- **ServerSettings（伺服器設定）**: 伺服器的資料庫連線、獎勵映射、通知設定等
- **Promotion（推廣）**: 推廣連結記錄，包含推廣代碼、連結、狀態、統計資料
- **PromotionClick（推廣點擊）**: 推廣連結點擊記錄，用於追蹤和分析
- **PromotionStats（推廣統計）**: 推廣效能統計，彙總點擊和轉換資料
- **Reward（獎勵）**: 獎勵記錄，包含獎勵類型、內容、數量、狀態、審核資訊
- **RewardSettings（獎勵設定）**: 獎勵規則定義，包含觸發條件、獎勵配置、限制條件
- **UserSession（使用者 Session）**: Session Token 記錄，用於認證
- **UserRole（使用者角色關聯）**: 多對多關聯表，記錄使用者與角色的關係
- **RolePermission（角色權限關聯）**: 多對多關聯表，記錄角色與權限的關係

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 新使用者能在 2 分鐘內完成註冊並創建第一個推廣連結
- **SC-002**: 使用者登入時間在 3 秒內完成（從輸入密碼到進入儀表板）
- **SC-003**: 推廣連結點擊追蹤準確率達 99%（正確記錄點擊事件）
- **SC-004**: 唯一訪客識別準確率達 95%（24小時內同一訪客不重複計數）
- **SC-005**: 自動獎勵發放成功率達 98%（資料庫連線正常時）
- **SC-006**: 獎勵從轉換到發放完成的平均時間少於 5 分鐘（自動審核+自動發放）
- **SC-007**: 系統支援 100 個伺服器同時運作，無效能下降
- **SC-008**: 系統支援 1000 個並發推廣連結點擊，響應時間少於 1 秒
- **SC-009**: API 回應時間中位數少於 200ms（90% 的請求）
- **SC-010**: 管理後台所有頁面載入時間少於 2 秒
- **SC-011**: 伺服器審核流程從提交到核准平均時間少於 24 小時
- **SC-012**: 95% 的使用者能在無需幫助文件的情況下完成推廣連結創建
- **SC-013**: 推廣素材生成時間（包含 QR Code）少於 3 秒
- **SC-014**: 資料匯出功能能處理 10 萬筆記錄的 CSV 匯出，時間少於 30 秒
- **SC-015**: 系統可用性達 99.5%（每月停機時間少於 3.6 小時）
- **SC-016**: 使用者能在 5 次點擊內找到任何管理功能
- **SC-017**: 推廣分析圖表在資料變更後 5 秒內更新
- **SC-018**: 批量審核 100 筆獎勵的處理時間少於 10 秒
- **SC-019**: 使用者滿意度達 4.5 分以上（5 分制）
- **SC-020**: 推廣連結的平均轉換率達 5% 以上（行業基準）

## Assumptions *(section included when needed)*

1. **資料庫效能**: 假設使用 MySQL 8.0+ 版本，已進行適當的索引優化，能支援高並發查詢
2. **網路環境**: 假設伺服器與遊戲資料庫之間的網路連線穩定，延遲低於 100ms
3. **使用者行為**: 假設大部分使用者使用桌面瀏覽器訪問管理後台，但前端仍需支援手機訪問
4. **推廣轉換定義**: 假設「推廣轉換」定義為新玩家透過推廣連結註冊並完成首次登入遊戲
5. **獎勵發放時機**: 假設獎勵發放可以有最多 5 分鐘的延遲，不需要即時發放
6. **圖片儲存**: 假設圖片儲存在本地檔案系統，未來可擴展至 CDN
7. **通知發送**: 假設 Email 和 LINE 通知為可選功能，配置後才啟用
8. **資料保留**: 假設推廣點擊記錄保留 1 年，獎勵記錄永久保留
9. **並發處理**: 假設使用資料庫層級的鎖定機制防止重複獎勵發放
10. **安全標準**: 假設使用標準的 Web 應用安全最佳實踐（OWASP Top 10 防護）
11. **語言支援**: 假設主要語言為繁體中文，介面文字可擴展至多語言
12. **瀏覽器支援**: 假設支援主流瀏覽器最近兩個版本（Chrome, Firefox, Safari, Edge）

## Dependencies *(section included when needed)*

### 外部系統依賴

1. **遊戲伺服器資料庫**: 系統需要連線至各伺服器的遊戲資料庫以發放獎勵，依賴資料庫的可用性和穩定性
2. **Email 服務**: 如啟用 Email 通知，需要 SMTP 服務或第三方 Email API（如 SendGrid, AWS SES）
3. **LINE Messaging API**: 如啟用 LINE 通知，需要 LINE 官方帳號和 Messaging API 金鑰

### 技術基礎設施依賴

1. **Web 伺服器**: 需要 Apache 或 Nginx 運行 PHP 應用程式
2. **PHP 運行環境**: PHP 8.1+ 及必要的擴展（mysqli, pdo, gd, curl, json）
3. **MySQL 資料庫**: MySQL 8.0+ 或 MariaDB 10.5+
4. **Node.js 環境**: Node.js 18+ 用於運行 Nuxt.js 前端
5. **Redis（規劃中）**: 用於快取和 Session 儲存，提升效能

### 功能模組依賴關係

1. **推廣系統依賴伺服器管理**: 只有已核准的伺服器才能被推廣
2. **獎勵系統依賴推廣系統**: 獎勵通常由推廣轉換觸發
3. **統計分析依賴推廣和獎勵資料**: 分析報表需要完整的推廣點擊和獎勵記錄
4. **自動發放依賴伺服器設定**: 必須先設定資料庫連線和獎勵表映射才能自動發放
5. **通知系統依賴伺服器設定**: 必須先設定通知方式（Email/LINE）才能發送通知

### 權限依賴

1. **伺服器管理依賴角色權限**: 使用者必須擁有服主或管理員角色才能管理伺服器
2. **獎勵審核依賴角色權限**: 使用者必須擁有審核員或管理員角色才能審核獎勵
3. **使用者管理依賴角色權限**: 使用者必須擁有管理員或超級管理員角色才能管理使用者

## Out of Scope *(section included when needed)*

以下功能**不在當前系統範圍內**，但可能在未來版本考慮：

### 活動系統（暫未實現）
- 累積型活動（累積推廣次數達標獲得獎勵）
- 連續型活動（連續登入/推廣獎勵）
- 時限型活動（限時推廣加倍獎勵）
- 每日簽到系統

### 進階通知功能
- 站內通知系統（訊息中心）
- WebSocket 即時通知推送
- 推播通知（PWA）
- SMS 簡訊通知

### 社群功能
- 使用者之間的私訊系統
- 推廣心得分享社群
- 伺服器評論和評分系統
- 使用者關注/粉絲系統

### 進階分析功能
- A/B 測試（比較不同推廣素材的效果）
- 熱力圖分析（使用者行為軌跡）
- 漏斗分析進階版（多階段轉換分析）
- 預測分析（預測推廣趨勢）

### 自動化推廣工具
- 自動生成推廣圖片（動態海報生成器）
- 推廣影片生成
- 社群媒體自動發文整合
- 推廣文案 AI 生成

### 金流與商業化
- 付費推廣方案（精選位置、推薦排序）
- 服主訂閱制度
- 平台抽成機制
- 發票開立系統

### 進階安全功能
- 兩步驟驗證（2FA）完整實作
- IP 白名單/黑名單管理
- DDoS 防護整合
- 完整的審計日誌查詢介面

### 多租戶功能
- 白標方案（讓其他平台使用本系統）
- 多品牌支援
- 客製化域名

### 國際化
- 多語言完整支援（目前僅部分支援）
- 多時區處理
- 多幣別支援

## Technical Constraints *(section included when needed)*

### 技術架構限制

1. **前後端分離架構**: 前端（Nuxt.js）和後端（CodeIgniter 4）必須保持分離，透過 RESTful API 通訊
2. **資料庫選擇**: 主資料庫必須使用 MySQL 8.0+ 或相容的關係型資料庫（如 MariaDB）
3. **PHP 版本**: 後端必須使用 PHP 8.1 或更高版本
4. **Node.js 版本**: 前端必須使用 Node.js 18 LTS 或更高版本

### 效能限制

1. **API 回應時間**: 90% 的 API 請求必須在 200ms 內回應
2. **資料庫查詢**: 單一查詢執行時間不得超過 1 秒
3. **檔案上傳**: 單一圖片檔案大小限制為 5MB
4. **並發連線**: 系統需支援至少 1000 個並發連線

### 安全限制

1. **密碼儲存**: 必須使用 bcrypt 或更強的雜湊演算法，禁止明文或弱加密
2. **Session 管理**: Token 必須設定合理的過期時間（Access Token 1小時，Refresh Token 7天）
3. **API 速率限制**: 每個 IP 每分鐘最多 60 次 API 請求
4. **CORS 政策**: 必須明確設定允許的來源域名，禁止 `Access-Control-Allow-Origin: *`

### 相容性限制

1. **瀏覽器支援**: 必須支援主流瀏覽器（Chrome, Firefox, Safari, Edge）最近兩個版本
2. **響應式設計**: 必須支援最小螢幕寬度 320px（手機）
3. **資料庫編碼**: 必須使用 UTF-8 編碼支援多語言字元

### 整合限制

1. **遊戲資料庫存取**: 只支援透過標準資料庫驅動（MySQLi, PDO）連線的資料庫
2. **第三方 API**: Email 和 LINE 通知整合需要服主自行提供 API 金鑰
3. **檔案儲存**: 當前版本只支援本地檔案系統儲存，CDN 整合需要額外開發

### 資料限制

1. **推廣代碼**: 必須為 32 字元長度，確保唯一性
2. **資料保留**: 推廣點擊記錄保留 1 年後可刪除，獎勵記錄需永久保留
3. **軟刪除**: 使用者、伺服器、推廣等核心資料必須使用軟刪除，不可實際刪除

### 開發規範限制

1. **API 設計**: 必須遵循 RESTful API 設計原則
2. **程式碼風格**: 後端必須遵循 CodeIgniter 4 編碼標準，前端遵循 Vue.js 風格指南
3. **Git 提交**: 禁止在提交訊息中加入「Generated with Claude Code」標記
4. **UI 框架**: 前端禁止使用 Element Plus，必須使用自訂元件或其他框架

## Business Rules *(section included when needed)*

### 使用者與角色規則

1. **預設角色**: 新註冊使用者自動分配「User（一般使用者）」角色
2. **角色升級**: 使用者要成為服主需要管理員手動分配「Server Owner」角色
3. **多角色權限**: 使用者可以同時擁有多個角色，權限為所有角色權限的聯集
4. **角色階層**: 低等級角色不能管理高等級角色的使用者（如服主不能編輯管理員）
5. **帳號鎖定**: 登入失敗 5 次後帳號鎖定 30 分鐘，第 6 次失敗後鎖定 1 小時

### 伺服器管理規則

1. **伺服器擁有權**: 註冊伺服器的使用者自動成為該伺服器的擁有者（server.owner_id）
2. **審核必要性**: 所有新註冊的伺服器必須經過審核才能啟用推廣功能
3. **伺服器代碼唯一性**: 每個伺服器的 server_code 必須全平台唯一
4. **伺服器停權**: 被停權的伺服器，其所有推廣連結自動暫停，待恢復後才能再次推廣
5. **精選伺服器**: 精選伺服器顯示於首頁推薦位置，精選期限到期後自動移除精選標記

### 推廣系統規則

1. **推廣限制**: 每個使用者對每個伺服器只能有一個活躍的推廣連結
2. **推廣資格**: 只有狀態為「active（已啟用）」的伺服器才能被推廣
3. **唯一訪客定義**: 同一 IP + User Agent + Fingerprint 在 24 小時內視為同一訪客，重複點擊不計入唯一點擊數
4. **推廣過期**: 推廣連結可設定過期時間，過期後點擊顯示友善訊息並引導至伺服器主頁
5. **轉換追蹤**: 只有透過推廣連結註冊並完成首次登入的玩家才計為轉換

### 獎勵發放規則

1. **自動創建**: 推廣轉換成功時，系統自動創建推廣獎勵記錄，狀態為「pending（待審核）」
2. **自動審核條件**: 只有當伺服器設定中開啟「auto_approve」時，獎勵才會自動審核
3. **發放順序**: 獎勵按照創建時間和優先級（priority）排序發放，優先級高的先發放
4. **重試機制**: 發放失敗的獎勵最多重試 3 次，3 次後仍失敗則標記為「failed」並通知管理員
5. **獎勵取消**: 已發放（distributed）的獎勵不可取消，只有 pending 和 approved 狀態的獎勵可取消
6. **獎勵數量限制**: 當觸發獎勵規則的數量限制（每日/每週/每月上限）時，拒絕創建新獎勵

### 獎勵設定規則

1. **規則優先級**: 當多個獎勵規則同時符合時，使用優先級（priority）最高的規則
2. **規則有效期**: 獎勵規則可設定有效期限（valid_from 到 valid_until），過期規則自動停用
3. **觸發條件**: 獎勵規則的觸發條件使用 JSON 格式定義，支援複雜的邏輯判斷
4. **數量限制**: 獎勵規則的限制（limits_config）分為每日、每週、每月三種，分別計算

### 統計與分析規則

1. **統計更新頻率**: 推廣統計每 5 分鐘更新一次，儀表板統計每 10 分鐘更新一次
2. **資料保留**: 推廣點擊記錄保留 1 年，超過 1 年的記錄可以歸檔或刪除
3. **排行榜計算**: 排行榜每小時重新計算一次，顯示前 100 名
4. **資料匯出限制**: 單次匯出資料不得超過 10 萬筆，超過需要分批匯出

### 安全規則

1. **Session Token 有效期**: Access Token 有效期 1 小時，Refresh Token 有效期 7 天
2. **Token 刷新**: Access Token 過期後可使用 Refresh Token 刷新，Refresh Token 過期後必須重新登入
3. **API 速率限制**: 每個 IP 每分鐘最多 60 次 API 請求，超過後返回 429 Too Many Requests
4. **CORS 控制**: API 只允許指定的前端域名訪問，拒絕其他來源的請求
5. **密碼強度**: 密碼最少 8 字元，必須包含英文和數字（可擴展至特殊字元）

### 操作審計規則

1. **敏感操作記錄**: 所有使用者管理、角色分配、伺服器審核、獎勵審核操作必須記錄
2. **審計保留**: 審計日誌永久保留，不可刪除
3. **追溯性**: 所有關鍵資料表必須記錄 created_at, updated_at, deleted_at（軟刪除）

---

**本規範文件整理自現有系統的完整分析，作為後續 SpecKit 工作流程的基準文件。**
